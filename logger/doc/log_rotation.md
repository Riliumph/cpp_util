# ログローテーションについて

## sinkで行うログローテーションとは

![sinkローテーションの原則](./specific_img/specific-rotation1.drawio.svg)

ロガーがシンクに書き込む際にローテーション判断を行う。

## 厳密な時間を保証できない

![厳密な時間管理](./specific_img/specific-rotation2.drawio.svg)

ロガーのsinkでローテーションを行うということは「ログに書き込まれる」という行動が必要である。  
毎分00秒にローテーションする機能を持たせたsinkを用意していてもsinkである以上「ログが書き込まれたとき」にローテーションするかどうかを判断し、ローテーションする。

そのため「1分間ログが書き込まれていない」という状況だと急にファイル名が飛ぶことになる。

## 同一ローテーション時間内の再起動は問題がある

![同一ローテーション時間](./specific_img/specific-rotation3.drawio.svg)

13:01:10にシステムを正常終了させる。  
13:01:40にシステムを再起動させる。  
13:01:50に初めてのログが書き込まれる。  
この条件の場合、13:02:00以降にログが書き込まれた際にログローテーションを行う。  
前回のシステム正常終了時にログをローテーションしているため、名前が被ってしまう問題がある。

1分以内で終わるシステムメンテナンスなどは稀なためケアは必要ない。  
ただし、コンテナを使った自動スケーリングを行う環境では、正常終了時のローテーションは行わない方がいいかもしれない。

※調査中

## 障害発生のケース

![障害発生ケース](./specific_img/specific-rotation4.drawio.svg)

障害が発生して正常終了しなかった場合、またはSIGKILLによって強引にシステムを終了させた場合は、終了時にローテーションが行われない。  
そのため、`app.log`がそのまま環境に残り続け、次の起動時に`app.log`を開いて追記していくことになる。

その場合、前回の異常終了時は正しくフラッシュされているとは限らないため、新規のログもフォーマットが崩れている可能性がある。  
json形式の場合、`}`で閉じられていないなど。  
そのため、必ずjson配列ではなく JSON Line形式を採用するのが望ましい。
