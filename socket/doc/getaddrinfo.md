# getaddrinfo関数

参考：

- [getaddrinfo](https://linuxjm.osdn.jp/html/LDP_man-pages/man3/getaddrinfo.3.html)

定義

```c
#include <sys/types.h>
#include <sys/socket.h>
#include <netdb.h>
int getaddrinfo(const char *node, const char *service,
                const struct addrinfo *hints,
                struct addrinfo **res);
```

---

## 第一引数について

以下のような情報を入れることができる。

- ホスト名：`example.com` / `localhost` / etc...  
  DNSによる名前解決が行われ、ホスト名に対応するIPアドレスが取得される。  
- IPアドレス：`192.168.0.1` / `127.0.0.1` etc...  
  指定されたIPアドレスに対応するアドレス情報が取得される。  
- それ以外：`NULL`  
  ワイルドカードアドレスが設定される。

> ワイルドカードアドレスとは  
>
> - IPv4 アドレスの場合は`INADDR_ANY`であり、具体的には`0.0.0.0`
> - IPv6 アドレスの場合は `IN6ADDR_ANY_INIT`であり、具体的には`::1`

### localhostを設定することの問題

サーバーのIPアドレスを決めるのだから`localhost`でいいやとアドレスを知らない人間は思うかもしれない。  

`localhost`が設定された場合の具体的な挙動を説明する。  
サーバーのIPに`127.0.0.1`が設定したとする。  
このサーバーは、`telnet 127.0.0.1 8000`など、`127.0.0.1`が明示的に指定されたアクセスのみで到達するサーバーになる。  
これは、**このサーバー内からしかアクセスできないこと**を意味する。

> 他のマシンから`127.0.0.1`でアクセスしようにも、別マシンには到達しない。

### NULLを設定する利便性

NULLを設定された場合に割り当てられる具体的なアドレスは`0.0.0.0`である。  
このアドレスは「すべてのNIC」を意味し、サーバープログラムを作る上で非常に便利である。

サーバーに２つのNIC（IPアドレス）が搭載されているとする。  
例えば、NIC-A(192.168.0.1)とNIC-B(192.168.1.1)だとする。

通常、`getaddrinfo`にはどちらかのアドレスを指定することになる。  
しかし、それでは不便だ。  
この二つのアドレスのどちらかでも同じサービスに到達して欲しい場合、`0.0.0.0`を指定することで解決できる。
ただし、そのあと、どちらからのアクセスだったのかを調べるにはソケットオプションを設定する必要がある。

---

## 第二引数について

以下のような情報を入れることができる。

- サービス名：`http` / `telnet`/ etc...  
  サービスに対応するポート番号が自動で判定される。
- ポート番号：`8000` / etc...  
  具体的なポート番号を指定する。  
  サービス名から特定できない、もしくはオリジナルなサービスの際に使用する。
- それ以外：`NULL`  
  OSによる動的ポート（短命ポートとも）を設定する

> サービス名とは  
> サービス情報データに記載されている関係のこと
>
> - Linux: `/etc/services`
> - Windows: `C:\Windowws\system32\drivers\etc\services`
>
> 動的ポートとは  
> OSが自動的に未使用ポートを割り当てる便利機能。  
> ただし、固定ポートではないためアプリケーションが起動するたびに番号が変化する。  
> そのため、一時的な運用に限られてしまい、サーバーなどには適用できない。

### 第一引数と第二引数のどちらをNULLにするか？

ドキュメントには以下のように書かれている。

> **`node`と`service`のどちらかは`NULL`にしてよいが、両方同時に`NULL`にしてはならない。**

OSによる動的ポートを採用したい場合に第二引数を`NULL`にすることが出来る。

## 第三引数について

第３引数は、`struct addrinfo`型のリンクリストを形成する
